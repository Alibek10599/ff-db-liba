"use strict";
var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
                t[p[i]] = s[p[i]];
        }
    return t;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.FlatFileDb = void 0;
const fs = require("fs");
const promises_1 = require("fs/promises");
const util = require("util");
var SIZE = 64;
class FlatFileDb {
    constructor(filePath) {
        this.filePath = filePath;
    }
    getFilePath() {
        return this.filePath;
    }
    async checkFileExists(path) {
        if (!fs.existsSync(path)) {
            await fs.writeFile(path, '[]', (err) => {
                if (err)
                    throw err;
            });
        }
        else {
            return true;
        }
    }
    async save(data) {
        let bytesRead = 0;
        let resultBuffer = Buffer.alloc(0);
        for (const record of data) {
            let buffer = Buffer.from(JSON.stringify(record.id).padEnd(SIZE, '\0'));
            const { id } = record, body = __rest(record, ["id"]);
            buffer = Buffer.concat([buffer, Buffer.from(JSON.stringify(body) + '\n')]);
            bytesRead += buffer.length;
            resultBuffer = Buffer.concat([resultBuffer, buffer], bytesRead);
        }
        await (0, promises_1.writeFile)(this.filePath, resultBuffer);
    }
    async getBufferStats(offset, position) {
        const promisifiedRead = util.promisify(fs.read);
        const fileHandle = await (0, promises_1.open)(this.filePath, 'r');
        const fd = await fileHandle.fd;
        const stat = await fileHandle.stat();
        const buffer = Buffer.alloc(stat.size);
        const { bytesRead } = await promisifiedRead(fd, buffer, offset, stat.size, position);
        return { buffer, bytesRead };
    }
    async getAllRecords() {
        const { buffer, bytesRead } = await this.getBufferStats(0, 0);
        const records = [];
        const data = buffer.toString('utf8', 0, bytesRead).split('\n');
        data.pop();
        for (const record of data) {
            if (record) {
                const body = record.substring(SIZE).trim();
                const id = record[1];
                records.push(Object.assign({ id: id }, JSON.parse(body)));
            }
        }
        return records;
    }
    async getRecordById(id) {
        const record = (await this.getAllRecords()).find((record) => record.id === id);
        if (!record)
            throw new Error(`Record with id ${id} not found`);
        return record;
    }
    async createRecord(record) {
        const { id } = record, body = __rest(record, ["id"]);
        const records = await this.getAllRecords();
        const recordId = records.length + 1;
        record.id = recordId.toString();
        records.push(Object.assign({ id: recordId.toString() }, body));
        await this.save(records);
        return record;
    }
    async updateRecord(id, record) {
        const records = await this.getAllRecords();
        const recordIndex = records.findIndex((record) => record.id === id);
        if (recordIndex === -1) {
            throw new Error(`Record with id ${id} not found`);
        }
        records[recordIndex] = record;
        await this.save(records);
        return record;
    }
    async deleteRecord(id) {
        const records = await this.getAllRecords();
        const record = records.find((record) => record.id === id);
        if (!record) {
            throw new Error(`Record with id ${id} not found`);
        }
        records.splice(records.indexOf(record), 1);
        await this.save(records);
        return id;
    }
}
exports.FlatFileDb = FlatFileDb;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmxhdC1maWxlLWRiLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2ZsYXQtZmlsZS1kYi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUFBLHlCQUF5QjtBQUN6QiwwQ0FBd0Q7QUFFeEQsNkJBQTZCO0FBSTdCLElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQztBQUVkLE1BQWEsVUFBVTtJQUduQixZQUFZLFFBQWdCO1FBQzFCLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO0lBQzNCLENBQUM7SUFFRCxXQUFXO1FBQ1QsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxLQUFLLENBQUMsZUFBZSxDQUFDLElBQVk7UUFDaEMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDeEIsTUFBTSxFQUFFLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQyxHQUFHLEVBQUUsRUFBRTtnQkFDbkMsSUFBSSxHQUFHO29CQUFFLE1BQU0sR0FBRyxDQUFDO1lBQ3ZCLENBQUMsQ0FBQyxDQUFDO1NBQ0o7YUFBTTtZQUNMLE9BQU8sSUFBSSxDQUFDO1NBQ2I7SUFDSCxDQUFDO0lBRUQsS0FBSyxDQUFDLElBQUksQ0FBSSxJQUFpQjtRQUN2QixJQUFJLFNBQVMsR0FBVyxDQUFDLENBQUM7UUFDMUIsSUFBSSxZQUFZLEdBQVcsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMzQyxLQUFLLE1BQU0sTUFBTSxJQUFJLElBQUksRUFBRTtZQUN2QixJQUFJLE1BQU0sR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUN2RSxNQUFNLEVBQUMsRUFBRSxLQUFhLE1BQU0sRUFBZCxJ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QUFFLENBQUMsQ0FBQztRQUMxRCxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ1gsTUFBTSxJQUFJLEtBQUssQ0FBQyxrQkFBa0IsRUFBRSxZQUFZLENBQUMsQ0FBQztTQUNuRDtRQUNELE9BQU8sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUMzQyxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDekIsT0FBTyxFQUFFLENBQUM7SUFDWixDQUFDO0NBQ0Y7QUFuR0gsZ0NBbUdHIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IHsgcmVhZEZpbGUsIHdyaXRlRmlsZSwgb3BlbiB9IGZyb20gJ2ZzL3Byb21pc2VzJztcbmltcG9ydCB7IGJ1ZmZlciB9IGZyb20gJ3N0cmVhbS9jb25zdW1lcnMnO1xuaW1wb3J0ICogYXMgdXRpbCBmcm9tICd1dGlsJztcblxuaW1wb3J0IHsgUmVjb3JkIH0gZnJvbSAnLi9pbnRlcmZhY2UnO1xuXG52YXIgU0laRSA9IDY0O1xuXG5leHBvcnQgY2xhc3MgRmxhdEZpbGVEYiB7XG4gICAgcHVibGljIGZpbGVQYXRoOiBzdHJpbmc7XG5cbiAgICBjb25zdHJ1Y3RvcihmaWxlUGF0aDogc3RyaW5nKSB7XG4gICAgICB0aGlzLmZpbGVQYXRoID0gZmlsZVBhdGg7XG4gICAgfVxuICAgIFxuICAgIGdldEZpbGVQYXRoKCk6IHN0cmluZyB7XG4gICAgICByZXR1cm4gdGhpcy5maWxlUGF0aDtcbiAgICB9XG4gIFxuICAgIGFzeW5jIGNoZWNrRmlsZUV4aXN0cyhwYXRoOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgIGlmICghZnMuZXhpc3RzU3luYyhwYXRoKSkgeyAgLy8gd2FzIHVzZWQgaW5zdGVhZCBvZiBmcy5wcm9taXNlcy5hY2Nlc3MgJiBmcy5hY2Nlc3MgdG8gcHJldmVudCByYWNlIGNvbmRpdGlvbnNcbiAgICAgICAgYXdhaXQgZnMud3JpdGVGaWxlKHBhdGgsICdbXScsIChlcnIpID0+IHtcbiAgICAgICAgICAgIGlmIChlcnIpIHRocm93IGVycjtcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gIFxuICAgIGFzeW5jIHNhdmU8VD4oZGF0YTogUmVjb3JkPFQ+W10pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgICAgIGxldCBieXRlc1JlYWQ6IG51bWJlciA9IDA7XG4gICAgICAgICAgICBsZXQgcmVzdWx0QnVmZmVyOiBCdWZmZXIgPSBCdWZmZXIuYWxsb2MoMCk7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IHJlY29yZCBvZiBkYXRhKSB7XG4gICAgICAgICAgICAgICAgbGV0IGJ1ZmZlciA9IEJ1ZmZlci5mcm9tKEpTT04uc3RyaW5naWZ5KHJlY29yZC5pZCkucGFkRW5kKFNJWkUsICdcXDAnKSk7XG4gICAgICAgICAgICAgICAgY29uc3Qge2lkLCAuLi5ib2R5fSA9IHJlY29yZDtcbiAgICAgICAgICAgICAgICBidWZmZXIgPSBCdWZmZXIuY29uY2F0KFtidWZmZXIsIEJ1ZmZlci5mcm9tKEpTT04uc3RyaW5naWZ5KGJvZHkpKyAnXFxuJyldKTtcbiAgICAgICAgICAgICAgICBieXRlc1JlYWQgKz0gYnVmZmVyLmxlbmd0aDtcbiAgICAgICAgICAgICAgICByZXN1bHRCdWZmZXIgPSBCdWZmZXIuY29uY2F0KFtyZXN1bHRCdWZmZXIsIGJ1ZmZlcl0sIGJ5dGVzUmVhZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBhd2FpdCB3cml0ZUZpbGUodGhpcy5maWxlUGF0aCwgcmVzdWx0QnVmZmVyKTtcbiAgICAgIFxuICAgIH1cblxuICAgIGFzeW5jIGdldEJ1ZmZlclN0YXRzKG9mZnNldDogbnVtYmVyLCBwb3NpdGlvbjogbnVtYmVyKTogUHJvbWlzZTx7IGJ1ZmZlcjogQnVmZmVyOyBieXRlc1JlYWQ6IG51bWJlciB9PiB7XG4gICAgICAgIGNvbnN0IHByb21pc2lmaWVkUmVhZCA9IHV0aWwucHJvbWlzaWZ5KGZzLnJlYWQpO1xuICAgICAgICBjb25zdCBmaWxlSGFuZGxlID0gYXdhaXQgb3Blbih0aGlzLmZpbGVQYXRoLCAncicpO1xuICAgICAgICBjb25zdCBmZCA9IGF3YWl0IGZpbGVIYW5kbGUuZmQ7XG4gICAgICAgIGNvbnN0IHN0YXQgPSBhd2FpdCBmaWxlSGFuZGxlLnN0YXQoKTtcbiAgICAgICAgY29uc3QgYnVmZmVyID0gQnVmZmVyLmFsbG9jKHN0YXQuc2l6ZSk7XG4gICAgICAgIGNvbnN0IHsgYnl0ZXNSZWFkIH0gPSBhd2FpdCBwcm9taXNpZmllZFJlYWQoZmQsIGJ1ZmZlciwgb2Zmc2V0LCBzdGF0LnNpemUsIHBvc2l0aW9uKTtcbiAgICAgICAgcmV0dXJuIHsgYnVmZmVyLCBieXRlc1JlYWQgfTtcbiAgICB9XG4gIFxuICAgIGFzeW5jIGdldEFsbFJlY29yZHM8VD4oKTogUHJvbWlzZTxSZWNvcmQ8VD5bXT4ge1xuICAgICAgICBjb25zdCB7IGJ1ZmZlciwgYnl0ZXNSZWFkIH0gPSBhd2FpdCB0aGlzLmdldEJ1ZmZlclN0YXRzKDAsIDApO1xuICAgICAgICBjb25zdCByZWNvcmRzOiBSZWNvcmQ8VD5bXSA9IFtdO1xuICAgICAgICBjb25zdCBkYXRhID0gYnVmZmVyLnRvU3RyaW5nKCd1dGY4JywgMCwgYnl0ZXNSZWFkKS5zcGxpdCgnXFxuJyk7XG4gICAgICAgIGRhdGEucG9wKCk7XG4gICAgICAgIGZvciAoY29uc3QgcmVjb3JkIG9mIGRhdGEpIHtcbiAgICAgICAgICAgIGlmIChyZWNvcmQpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBib2R5ID0gcmVjb3JkLnN1YnN0cmluZyhTSVpFKS50cmltKCk7XG4gICAgICAgICAgICAgICAgY29uc3QgaWQgPSByZWNvcmRbMV07XG4gICAgICAgICAgICAgICAgcmVjb3Jkcy5wdXNoKHtpZDogaWQsIC4uLkpTT04ucGFyc2UoYm9keSl9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVjb3JkcztcbiAgICB9XG4gIFxuICAgIGFzeW5jIGdldFJlY29yZEJ5SWQ8VD4oaWQ6IHN0cmluZyk6IFByb21pc2U8UmVjb3JkPFQ+PiB7XG4gICAgICBjb25zdCByZWNvcmQgPSAoYXdhaXQgdGhpcy5nZXRBbGxSZWNvcmRzPFQ+KCkpLmZpbmQoXG4gICAgICAgIChyZWNvcmQpID0+IHJlY29yZC5pZCA9PT0gaWRcbiAgICAgICk7XG4gICAgICBpZiAoIXJlY29yZCkgdGhyb3cgbmV3IEVycm9yKGBSZWNvcmQgd2l0aCBpZCAke2lkfSBub3QgZm91bmRgKTtcbiAgICAgIHJldHVybiByZWNvcmQ7XG4gICAgfVxuICBcbiAgICBhc3luYyBjcmVhdGVSZWNvcmQ8VD4ocmVjb3JkOiBSZWNvcmQ8VD4pOiBQcm9taXNlPFJlY29yZDxUPj4ge1xuICAgICAgICBjb25zdCB7aWQsIC4uLmJvZHl9ID0gcmVjb3JkO1xuICAgICAgY29uc3QgcmVjb3JkcyA9IGF3YWl0IHRoaXMuZ2V0QWxsUmVjb3JkcygpO1xuICAgICAgY29uc3QgcmVjb3JkSWQ6IG51bWJlciA9IHJlY29yZHMubGVuZ3RoICsgMTtcbiAgICAgIHJlY29yZC5pZCA9IHJlY29yZElkLnRvU3RyaW5nKCk7XG4gICAgICByZWNvcmRzLnB1c2goeyBpZDogcmVjb3JkSWQudG9TdHJpbmcoKSwgLi4uYm9keSB9KTtcbiAgICAgIGF3YWl0IHRoaXMuc2F2ZShyZWNvcmRzKTtcbiAgICAgIHJldHVybiByZWNvcmQ7XG4gICAgfVxuICBcbiAgICBhc3luYyB1cGRhdGVSZWNvcmQ8VD4oaWQ6IHN0cmluZywgcmVjb3JkOiBSZWNvcmQ8VD4pOiBQcm9taXNlPFJlY29yZDxUPj4ge1xuICAgICAgY29uc3QgcmVjb3JkcyA9IGF3YWl0IHRoaXMuZ2V0QWxsUmVjb3JkcygpO1xuICAgICAgY29uc3QgcmVjb3JkSW5kZXggPSByZWNvcmRzLmZpbmRJbmRleCgocmVjb3JkKSA9PiByZWNvcmQuaWQgPT09IGlkKTtcbiAgICAgIGlmIChyZWNvcmRJbmRleCA9PT0gLTEpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBSZWNvcmQgd2l0aCBpZCAke2lkfSBub3QgZm91bmRgKTtcbiAgICAgIH1cbiAgICAgIHJlY29yZHNbcmVjb3JkSW5kZXhdID0gcmVjb3JkO1xuICAgICAgYXdhaXQgdGhpcy5zYXZlKHJlY29yZHMpO1xuICAgICAgcmV0dXJuIHJlY29yZDtcbiAgICB9XG4gIFxuICAgIGFzeW5jIGRlbGV0ZVJlY29yZChpZDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICAgIGNvbnN0IHJlY29yZHMgPSBhd2FpdCB0aGlzLmdldEFsbFJlY29yZHMoKTtcbiAgICAgIGNvbnN0IHJlY29yZCA9IHJlY29yZHMuZmluZCgocmVjb3JkKSA9PiByZWNvcmQuaWQgPT09IGlkKTtcbiAgICAgIGlmICghcmVjb3JkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgUmVjb3JkIHdpdGggaWQgJHtpZH0gbm90IGZvdW5kYCk7XG4gICAgICB9XG4gICAgICByZWNvcmRzLnNwbGljZShyZWNvcmRzLmluZGV4T2YocmVjb3JkKSwgMSk7XG4gICAgICBhd2FpdCB0aGlzLnNhdmUocmVjb3Jkcyk7XG4gICAgICByZXR1cm4gaWQ7XG4gICAgfVxuICB9XG4gICJdfQ==